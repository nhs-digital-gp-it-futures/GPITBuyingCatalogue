@using NHSD.GPIT.BuyingCatalogue.Framework.Extensions
@using NHSD.GPIT.BuyingCatalogue.ServiceContracts.Enums
@model NHSD.GPIT.BuyingCatalogue.WebApp.Models.OrganisationModels.UsersModel
@{
    ViewBag.Title = "User Accounts";
}
@section Breadcrumbs {
    <nav class="nhsuk-breadcrumb" aria-label="Breadcrumb">
        <div class="nhsuk-width-container">
            <ol class="nhsuk-breadcrumb__list">
                <li class="nhsuk-breadcrumb__item">
                    <a href="@Model.HomeLink"
                       class="nhsuk-breadcrumb__link">Home</a>
                </li>
            @if (User.IsAdmin())
            {
                <li class="nhsuk-breadcrumb__item">
                    <a asp-action="@nameof(OrganisationController.Index)"
                       asp-controller="@ViewContext.RouteData.Values["controller"]"
                       class="nhsuk-breadcrumb__link">Manage buyer organisations</a>
                </li>
            }
                <li class="nhsuk-breadcrumb__item">
                    <a asp-action="@nameof(OrganisationController.Details)"
                       asp-controller="@ViewContext.RouteData.Values["controller"]"
                       asp-route-organisationId="@Model!.OrganisationId"
                       class="nhsuk-breadcrumb__link">Organisation details</a>
                </li>
            </ol>
        </div>
    </nav>
}
<div class="nhsuk-grid-row">
    <div class="nhsuk-grid-column-full">
        <nhs-page-title title="@ViewBag.Title"
                        caption="@Model!.OrganisationName"
                        advice="Add, edit and view user accounts for this organisation." />

        <vc:nhs-action-link text="Add a user"
                            url="@Url.Action(
                                     nameof(OrganisationController.AddUser),
                                     ViewContext.RouteData.Values["controller"].ToString(),
                                     new { Model.OrganisationId })" />

        <h3>Existing users</h3>
        <input type="hidden" asp-for="@Model.HomeLink" />
        @if (Model.Users.Any())
        {
            <div data-test-id="users-table">
                <nhs-table>
                    @foreach (var heading in new[] { "Name", "Email address", "Account Status", "Action" })
                    {
                        <nhs-table-column>@heading</nhs-table-column>
                    }

                    @foreach (var item in Model.Users)
                    {
                        <nhs-table-row-container>
                            <nhs-table-cell>
                                <span data-test-id="user-name">
                                    @item.GetDisplayName()
                                </span>
                            </nhs-table-cell>
                            <nhs-table-cell>
                                <span data-test-id="user-email">
                                    @item.Email
                                </span>
                            </nhs-table-cell>
                            <nhs-table-cell>
                                @{
                                    var status = item.Disabled ? AccountStatus.Inactive : AccountStatus.Active;
                                    <nhs-tag status-enum="@status"/>
                                }
                            </nhs-table-cell>
                            <nhs-table-cell>
                                <span data-test-id="user-status-link">
                                    @{
                                        var text = item.Disabled ? "Activate" : "Deactivate";
                                        <a asp-action="@nameof(OrganisationController.UserStatus)"
                                           asp-controller=@ViewContext.RouteData.Values["controller"].ToString()
                                           asp-route-organisationId="@Model.OrganisationId"
                                           asp-route-userId="@item.Id">@text</a>
                                    }
                                </span>
                            </nhs-table-cell>
                        </nhs-table-row-container>
                    }
                </nhs-table>
            </div>
        }
        else
        {
            <div data-test-id="users-error-message">
                <p>No user accounts have been created for this organisation.</p>
            </div>
        }

        <vc:nhs-secondary-button text="Continue" 
                                 url="@Url.Action(
                                          nameof(OrganisationController.Details),
                                          ViewContext.RouteData.Values["controller"].ToString(),
                                          new { Model.OrganisationId })"
                                 type="Primary" />
    </div>
</div>
