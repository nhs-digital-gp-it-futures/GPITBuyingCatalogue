@using System.Linq;
@using NHSD.GPIT.BuyingCatalogue.Framework.Calculations;
@using NHSD.GPIT.BuyingCatalogue.Framework.Extensions;
@using NHSD.GPIT.BuyingCatalogue.WebApp.Areas.Order.Controllers;
@using NHSD.GPIT.BuyingCatalogue.WebApp.Areas.Order.Controllers.SolutionSelection

@model NHSD.GPIT.BuyingCatalogue.WebApp.Areas.Order.Models.SolutionSelection.Review.ReviewSolutionsModel
@{
	ViewBag.Title = Model.AssociatedServicesOnly
        ? "Associated Services"
	    : "Catalogue Solution and services";

    var advice = Model.AssociatedServicesOnly
        ? "Review the Associated Services that you've added to this order. You can edit the items that you've added at any time."
        : "Review the Catalogue Solution and any services that you've added to this order. You can edit the items that you've added at any time.";

    var editLinkTitle = Model.AssociatedServicesOnly
        ? "Edit Associated Services"
        : "Edit solution and services";

	var oneOffCost = Model.AllOrderItems
		.Where(oi => oi.OrderItemPrice?.EstimationPeriod == null)
		.Sum(oi => oi.OrderItemPrice.CalculateTotalCost(oi.GetQuantity()));

	var monthlyCost = Model.AllOrderItems
		.Where(oi => oi.OrderItemPrice?.EstimationPeriod != null)
		.Sum(oi => oi.OrderItemPrice.CalculateCostPerMonth(oi.GetQuantity()));

	var yearlyCost = Model.AllOrderItems
		.Where(oi => oi.OrderItemPrice?.EstimationPeriod != null)
		.Sum(oi => oi.OrderItemPrice.CalculateCostPerYear(oi.GetQuantity()));

	var totalCost = Model.AllOrderItems
		.Sum(oi => oi.OrderItemPrice.CalculateTotalCostForContractLength(oi.GetQuantity(), Model.ContractLength));
}

<partial name="Partials/_BackLink" model="Model" />

<div class="nhsuk-grid-row">
    <div class="nhsuk-grid-column-full">
        <nhs-page-title title="@ViewBag.Title"
						caption="Order @Model.CallOffId"
						advice="@advice"/>

        <vc:nhs-action-link text="@editLinkTitle" 
                            url="@Url.Action(
                                     nameof(TaskListController.TaskList),
                                     typeof(TaskListController).ControllerName(),
                                     new { Model.InternalOrgId, Model.CallOffId })" />
		<hr />

		@if (Model.CatalogueSolution != null)
		{
			<h2 id="catalogue-solutions-title">Catalogue Solution</h2>
			<partial name="_ReviewExpander" model="Model.CatalogueSolution" />
		}

		@if (Model.AdditionalServices.Any())
		{
			<h2 id="additional-services-title">Additional Services</h2>
			@foreach (var service in Model.AdditionalServices)
			{
				<partial name="_ReviewExpander" model="service" />
			}
		}

		@if (Model.AssociatedServices.Any())
		{
			<h2 id="associated-services-title">Associated Services</h2>
			@foreach (var service in Model.AssociatedServices)
			{
				<partial name="_ReviewExpander" model="service" />
			}
		}
		<br/>
		<nhs-summary-list>
			<nhs-summary-list-row label-text="Total one-off cost:">£@oneOffCost.ToString("N")</nhs-summary-list-row>
			<nhs-summary-list-row label-text="Total monthly cost:">£@monthlyCost.ToString("N")</nhs-summary-list-row>
			<nhs-summary-list-row label-text="Total cost for one year:">£@yearlyCost.ToString("N")</nhs-summary-list-row>
			<nhs-summary-list-row label-text="Total cost of contract (@Model.ContractLength months):">£@totalCost.ToString("N")</nhs-summary-list-row>
		</nhs-summary-list>
        
        <div class="nhsuk-u-margin-bottom-3">
            <vc:nhs-secondary-button text="Download PDF" 
                                     use-primary-colour="false" 
                                     url="@Url.Action(
                                              nameof(ReviewSolutionsController.Download), 
                                              typeof(ReviewSolutionsController).ControllerName(), 
                                              new { Model.InternalOrgId, Model.CallOffId })"/>
        </div>

        <vc:nhs-secondary-button 
			text="Continue" 
			use-primary-colour="true" 
			url="@Url.Action(
					nameof(OrderController.Order), 
					typeof(OrderController).ControllerName(), 
					new { Model.InternalOrgId, Model.CallOffId })"/>
	</div>
</div>

