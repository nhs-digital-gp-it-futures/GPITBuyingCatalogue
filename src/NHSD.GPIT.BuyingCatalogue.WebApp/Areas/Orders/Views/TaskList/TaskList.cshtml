@using NHSD.GPIT.BuyingCatalogue.EntityFramework.Ordering.Models
@using NHSD.GPIT.BuyingCatalogue.ServiceContracts.Routing
@using NHSD.GPIT.BuyingCatalogue.WebApp.Areas.Orders.Controllers.SolutionSelection
@model NHSD.GPIT.BuyingCatalogue.WebApp.Areas.Orders.Models.SolutionSelection.TaskList.TaskListModel

@{
    ViewBag.Title = Model.Title;
}

<partial name="Partials/_BackLink" model="Model" />

<div class="nhsuk-grid-row">
    <div class="nhsuk-grid-column-two-thirds">
        <nhs-validation-summary />
        <nhs-page-title model="Model" />

        @if (Model.OrderType.AssociatedServicesOnly)
        {
            <h2>Catalogue Solution</h2>

            <h3>@Model.SolutionName</h3>
            if (Model.AlternativeSolutionsAvailable && !Model.IsAmendment)
            {
                <vc:nhs-action-link text="Change Catalogue Solution"
                                    url="@Url.Action(
                                             nameof(CatalogueSolutionsController.EditSolution),
                                             typeof(CatalogueSolutionsController).ControllerName(),
                                             new { Model.InternalOrgId, Model.CallOffId })" />

            }
        }
        else
        {
            <div id="SolutionDetails" class="nhsuk-u-margin-bottom-9">
                <h2>Catalogue Solution</h2>

                @if (Model.CatalogueSolution != null)
                {
                    <nhs-card-v2>
                        <nhs-card-content>
                            <partial name="TaskListOrderItem"
                                     model="@Model.OrderItemModel(Model.CatalogueSolution.CatalogueItemId)" />
                        </nhs-card-content>
                        <nhs-card-footer>
                            @if (!Model.IsAmendment)
                            {
                                if (Model.AlternativeSolutionsAvailable)
                                {
                                    <a class="nhsuk-link--no-visited-state" href="@Url.Action(
                                    nameof(CatalogueSolutionsController.EditSolution),
                                    typeof(CatalogueSolutionsController).ControllerName(),
                                    new { Model.InternalOrgId, Model.CallOffId })">Change Catalogue Solution</a>
                                }
                                else
                                {
                                    <img src="~/images/information-icon.png" style="vertical-align:middle" /> <p>There is only 1 solution offered by this supplier.</p>
                                }
                            }
                            else
                            {
                                <img src="~/images/information-icon.png" style="vertical-align:middle" /> <p>You cannot change your Catalogue Solution when amending an order.</p>
                            }
                        </nhs-card-footer>
                        
                    </nhs-card-v2>
                }
            </div>
        }

        @if (!Model.OrderType.AssociatedServicesOnly)
        {
            <div id="AdditionalServiceDetails" class="nhsuk-u-margin-bottom-9">
                <h2>Additional Services</h2>
                <nhs-card-v2>
                    @if (Model.AdditionalServicesAvailable)
                    {
                        <nhs-card-content>
                            @if (Model.AdditionalServices.Any())
                            {
                                @foreach (var service in Model.AdditionalServices)
                                {
                                    <partial name="TaskListOrderItem"
                                    model="@Model.OrderItemModel(service.CatalogueItemId)" />
                                    @if (!(Model.IsAmendment && (Model.Previous?.Exists(service.CatalogueItemId) ?? false)))
                                    {
                                        <vc:nhs-delete-button url="@Url.Action(nameof(CatalogueSolutionsController.RemoveService),
                                                                            typeof(CatalogueSolutionsController).ControllerName(),
                                                                            new { Model.InternalOrgId, Model.CallOffId, service.CatalogueItemId })"
                                        text="Remove @service.CatalogueItem.Name" />
                                        <hr class="nhsuk-section-break nhsuk-section-break--m nhsuk-section-break--visible">
                                    }
                                    else
                                    {
                                        <br />
                                    }
                                }
                            }
                            else
                            {
                                <p>No Additional Services have been added to this order yet.</p>
                            }
                        </nhs-card-content>
                        <nhs-card-footer>
                            @if (Model.UnselectedAdditionalServicesAvailable)
                            {
                                <p class="nhsuk-body-m">
                                    <a class="nhsuk-link--no-visited-state" href="@Url.Action(
                                            nameof(AdditionalServicesController.SelectAdditionalServices),
                                            typeof(AdditionalServicesController).ControllerName(),
                                            new { Model.InternalOrgId, Model.CallOffId })">
                                            <img src="~/images/plus-icon.svg" style="vertical-align:middle" width="25px" />
                                            Add an Additional Service
                                    </a>
                                </p>
                            }
                            else
                            {
                                <img src="~/images/information-icon.png" style="vertical-align:middle" /> <p>All the Additional Services available for this Catalogue Solution have already been added.</p>
                            }

                        </nhs-card-footer>
                    }
                    else
                    {
                        <nhs-card-content>
                            <img src="~/images/information-icon.png" style="vertical-align:middle" /> <p>There are no Additional Services available for this Catalogue Solution.</p>
                        </nhs-card-content>
                    }
                </nhs-card-v2>
            </div>
        }

        
        <div id="AssociatedServiceDetails" class="nhsuk-u-margin-bottom-9">
            <h2>Associated Services</h2>

            <nhs-card-v2>
                @if (Model.IsAmendment && !Model.AssociatedServices.Any())
                {
                    <nhs-card-content>
                        <img src="~/images/information-icon.png" style="vertical-align:middle; display:inline-block; padding-right:5px" /><span style="display:inline-block; vertical-align:middle; width:90%">You cannot add Associated Services when amending an order.</span>
                    </nhs-card-content>
                }
                else if (!Model.AssociatedServicesAvailable)
                {
                    <nhs-card-content>
                        <img src="~/images/information-icon.png" style="vertical-align:middle; display:inline-block; padding-right:5px" /><span style="display:inline-block; vertical-align:middle; width:90%">There are no Associated Services available for this Catalogue Solution.</span>
                    </nhs-card-content>
                }
                else
                {
                    <nhs-card-content>
                        @if (Model.AssociatedServices.Any())
                        {
                            @foreach (var service in Model.AssociatedServices)
                            {
                                <partial name="TaskListOrderItem"
                                model="@Model.OrderItemModel(service.CatalogueItemId)" />
                                @if (!Model.OrderType.MergerOrSplit)
                                {
                                    <vc:nhs-delete-button url="@Url.Action(nameof(CatalogueSolutionsController.RemoveService),
                                                                            typeof(CatalogueSolutionsController).ControllerName(),
                                                                            new { Model.InternalOrgId, Model.CallOffId, service.CatalogueItemId })"
                                    text="Remove @service.CatalogueItem.Name" />
                                    <hr class="nhsuk-section-break nhsuk-section-break--m nhsuk-section-break--visible">
                                }
                            }
                        }
                        else
                        {
                            <p>No Associated Services have been added to this order yet.</p>
                        }
                    </nhs-card-content>
                    
                    @if (!Model.OrderType.MergerOrSplit)
                    {
                        <nhs-card-footer>
                            @if (Model.IsAmendment)
                            {
                                <img src="~/images/information-icon.png" style="vertical-align:middle" /> <p>You cannot add Associated Services or edit ones included in the original order when amending an order.</p>
                            }
                            else if (!Model.UnselectedAssociatedServicesAvailable)
                            {
                                <img src="~/images/information-icon.png" style="vertical-align:middle" /> <p>All the Associated Services available for this Catalogue Solution have already been added.</p>
                            }
                            else
                            {
                                <a class="nhsuk-link--no-visited-state" href="@Url.Action(
                                    nameof(AssociatedServicesController.SelectAssociatedServices),
                                    typeof(AssociatedServicesController).ControllerName(),
                                    new { Model.InternalOrgId, Model.CallOffId, source = RoutingSource.TaskList })">
                                    <img src="~/images/plus-icon.svg" style="vertical-align:middle" width="25px" />
                                    <p>Add an Associated Service</p>
                                </a>
                            }
                        </nhs-card-footer>
                    }
                }                
            </nhs-card-v2>
        </div>

        <vc:nhs-secondary-button text="Continue"
                                 url="@Model.OnwardLink"
                                 type="Primary" />
    </div>
</div>
