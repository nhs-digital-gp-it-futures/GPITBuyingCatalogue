@using NHSD.GPIT.BuyingCatalogue.WebApp.Controllers
@using NHSD.GPIT.BuyingCatalogue.Framework.Extensions
@using NHSD.GPIT.BuyingCatalogue.WebApp.Areas.Solutions.Controllers
@model NHSD.GPIT.BuyingCatalogue.WebApp.Areas.Solutions.Models.FilterCapabilitiesModel

@{
    Layout = "~/Views/Shared/Layouts/_AllBannersLayout.cshtml";
    var index = 0;
}

@section Breadcrumbs {
    <nav class="nhsuk-breadcrumb" aria-label="Breadcrumb">
        <div class="nhsuk-width-container">
            <ol class="nhsuk-breadcrumb__list">
                <li class="nhsuk-breadcrumb__item">
                    <a class="nhsuk-breadcrumb__link"
                       data-test-id="home-crumb"
                       asp-action="@nameof(HomeController.Index)"
                       asp-controller="@typeof(HomeController).ControllerName()"
                       asp-area="@typeof(HomeController).AreaName()">Home</a>
                </li>
                <li class="nhsuk-breadcrumb__item">
                    <a class="nhsuk-breadcrumb__link"
                       data-test-id="catalogue-solutions-crumb"
                       asp-action="@nameof(SolutionsController.Index)"
                       asp-controller="@typeof(SolutionsController).ControllerName()"
                       asp-area="@typeof(SolutionsController).AreaName()">Catalogue Solutions</a>
                </li>
                <li class="nhsuk-breadcrumb__item">
                    Capabilities
                </li>
            </ol>
        </div>
    </nav>
}

<script>
    window.onload = function() {
        updateTotal();
        updateGroupCounters();
        document.getElementById('selection-counter').removeAttribute('style');
        const allCheckBoxes = document.querySelectorAll('.nhsuk-checkboxes__input');
        for (let i = 0; i < allCheckBoxes.length; i++) {
            allCheckBoxes[i].addEventListener('change', checkBoxClicked, false);
        }
    }

    function checkBoxClicked(checkBox) {
        updateGroupCount(checkBox.target.getAttribute('subgroup'));
        updateTotal();
    }

    function updateGroupCount(subgroup) {
        const count = document.querySelectorAll(`.nhsuk-checkboxes__input[subgroup=${subgroup}]:checked`).length;
        const counter = document.querySelector(`.counter-class[subgroup=${subgroup}]`);
        counter.innerText = count > 0 ? ` - ${count} selected` : '';
    }

    function updateGroupCounters() {
        Array.from(document.querySelectorAll(`.nhsuk-checkboxes__input:checked`))
            .map(x => x.getAttribute('subgroup'))
            .filter((value, index, self) => self.indexOf(value) === index)
            .forEach(x => updateGroupCount(x));
    }

    function updateTotal() {
        const selected = document.querySelectorAll('.nhsuk-checkboxes__input:checked').length;
        const total = document.querySelectorAll('.nhsuk-checkboxes__input').length;
        document.getElementById('selection-counter').innerText = `${selected} out of ${total} selected`;
    }
</script>

<div class="nhsuk-grid-row">
    <div class="nhsuk-grid-column-full">
        <nhs-page-title title="Filter by Capabilities for Catalogue Solutions"
                        advice="Capabilities describe business needs. Select the ones you want a Catalogue Solution to address."/>

        <hr/>
        <h2>@Model.TotalCapabilities Capabilities have been found:</h2>
        <hr/>

        <div class="nhsuk-u-margin-bottom-9">
            <h3>Select Capabilities</h3>
            <p id="selection-counter" style="display: none">
                0 out of @Model.TotalCapabilities selected
            </p>
        </div>

        <form method="post">
            @foreach (var category in Model.Categories)
            {
                var capabilities = Model.Capabilities(category.Id);
                <nhs-expander heading-text="@category.Name"
                              label-text="@capabilities.Count @(capabilities.Count == 1 ? "result" : "results")"
                              open="true">
                    <p>
                        @category.Description
                    </p>
                    <nhs-table label-text="Capability name">
                        @foreach (var capability in capabilities)
                        {
                            <nhs-table-row-container>
                                <nhs-table-cell>
                                    <nhs-checkbox-container>
                                        <nhs-checkbox asp-for="Items[index].Selected"
                                                      hidden-input="Items[index].Id"
                                                      label-text="@capability.Name"
                                                      sub-group="@category.Name"/>
                                    </nhs-checkbox-container>
                                </nhs-table-cell>
                            </nhs-table-row-container>
                            index++;
                        }
                    </nhs-table>
                </nhs-expander>
                <br/>
            }
            <nhs-submit-button/>
        </form>
    </div>
</div>
